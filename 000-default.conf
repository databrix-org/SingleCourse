#Listen 80
<VirtualHost *:80>
  ServerName 1985609f-7839-4819-8840-2d38548e4ea5.ma.bw-cloud-instance.org
  Redirect / https://1985609f-7839-4819-8840-2d38548e4ea5.ma.bw-cloud-instance.org/
</VirtualHost>

#Listen 443
<VirtualHost *:443>
  ServerName 1985609f-7839-4819-8840-2d38548e4ea5.ma.bw-cloud-instance.org

  SSLProxyEngine on
  ServerSignature Off

  # Enable HTTP/2, if available
  Protocols h2 http/1.1

  # HTTP Strict Transport Security (mod_headers is required) (63072000 seconds)
  # HTTP Strict Transport Security (mod_headers is required) (63072000 seconds)
  Header always set Strict-Transport-Security "max-age=63072000"
  Header set Content-Security-Policy "frame-ancestors 'self' https://1985609f-7839-4819-8840-2d38548e4ea5.ma.bw-cloud-instance.org;"
  # Configure SSL
  SSLEngine on
  SSLCertificateFile /etc/letsencrypt/live/1985609f-7839-4819-8840-2d38548e4ea5.ma.bw-cloud-instance.org/fullchain.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/1985609f-7839-4819-8840-2d38548e4ea5.ma.bw-cloud-instance.org/privkey.pem
  #Include /etc/letsencrypt/options-ssl-apache.conf
  SSLOpenSSLConfCmd DHParameters /etc/ssl/certs/dhparams.pem
  # Intermediate configuration from SSL-config.mozilla.org (2022-03-03)
  # Please note, that this configuration might be outdated - please update it accordingly using https://ssl-config.mozilla
  SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
  SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
  SSLHonorCipherOrder off
  SSLSessionTickets off



  # Jupyter-collaboration URL contains %, Apache must % understand
  AllowEncodedSlashes             On                                                                              #----------------------Shibboleth-------------------------------
  UseCanonicalName          On
  Include     /etc/shibboleth-ds/shibboleth-ds.conf
  Redirect       seeother /shibboleth https://1985609f-7839-4819-8840-2d38548e4ea5.ma.bw-cloud-instance.org/Shibb>  RedirectMatch /start-session$ /Shibboleth.sso/Login

  <Location /Shibboleth.sso>                                                                                          AuthType None
    Require all granted
  </Location>

  <Location /shibboleth-sp>
    AuthType None
    Require all granted
  </Location>
    Alias /shibboleth-sp/main.css /usr/share/shibboleth/main.css

#----------------------static files-----------------------------
  # Alias for Static Files
  Alias /static/ /app/staticfiles/
  <Directory /app/staticfiles>
      Require all granted
  </Directory>

  # Alias for Media Files
  Alias /data/ /app/data/
  <Directory /app/data>
      Require all granted
  </Directory>

  # WSGI Configuration
  WSGIDaemonProcess SingleCourseWebApp python-path=/app python-home=/opt/venv
  WSGIProcessGroup SingleCourseWebApp
  WSGIScriptAlias / /app/app/wsgi.py

  <Directory /app/app>
      <Files wsgi.py>
          Require all granted
      </Files>
  </Directory>

  # Logging
  ErrorLog ${APACHE_LOG_DIR}/singlecourse_error.log
  CustomLog ${APACHE_LOG_DIR}/singlecourse_access.log combined

  # Security Headers (Optional)
  <IfModule mod_headers.c>
      Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
      Header always set X-Content-Type-Options "nosniff"
      Header always set X-Frame-Options "DENY"
      Header always set X-XSS-Protection "1; mode=block"
        </IfModule>


#----------------------APP-------------------------------
  # JupyterHub proxy configuration
  <Location /auth>
    #AuthType shibboleth
    #ShibRequestSetting requireSession 1
    #require valid-user
    RewriteEngine On
    ProxyPreserveHost On
    ShibUseHeaders On

    ProxyPass http://193.196.55.219:8008/auth
    ProxyPassReverse http://193.196.55.219:8008/auth
  </Location>

  <Location /course>
    #AuthType shibboleth
    #ShibRequestSetting requireSession 1
    ShibUseHeaders On
    RewriteEngine On
    ProxyPreserveHost On
        ProxyPass http://193.196.55.219:8008/course
    ProxyPassReverse http://193.196.55.219:8008/course
  </Location>

  <Location />
    AuthType shibboleth
    ShibRequestSetting requireSession 1
    require valid-user
    RequestHeader set HTTP_MAIL %{mail}e env=mail
    RequestHeader set HTTP_GIVENNAME %{givenName}e env=givenName
    RequestHeader set HTTP_SN %{sn}e env=sn
    RequestHeader set HTTP_UID %{uid}e env=uid
  </Location>

  <Location /admin>
    ShibRequestSetting requireSession off
    ShibUseHeaders On
    RewriteEngine On
    ProxyPreserveHost On

    ProxyPass http://193.196.55.219:8008/admin
    ProxyPassReverse http://193.196.55.219:8008/admin
  </Location>
</VirtualHost>